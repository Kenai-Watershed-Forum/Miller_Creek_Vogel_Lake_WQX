# Miller Creek Discharge

### Introduction

Field data to create a ratings curve of discharge at the mouth of Miller Creek is being collected from Fall 2020 - Spring 2021. These methods and results will be presented here.

Raw water quality field data is stored in a Google Sheet that can be viewed at <https://tinyurl.com/kwf-vogel-wqx-data> under the "Discharge Measurements" tab.

Site photos are available through a point-and-click pop-up map at <https://arcg.is/0fqvb0>.

```{r setup_02, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

# clear environment
rm(list=ls())

# load packages
library(bookdown)
library(tidyverse)
library(googlesheets4)
library(lubridate)
library(readr)
library(readxl)
library(writexl)
library(hms)
library(plotly)
library(DT)
library(xlsx)
library(leaflet)
library(DT)
library(ggpubr)
library(plotrix)
library(packrat)

# set plotting themes

## geom_col plots theme
col_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 14))

## geom_points plots theme
points_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 11, face = "bold"),
                   title = element_text(size = 18))

# function to exclude multiple items per column
'%ni%' <- Negate('%in%')

# clarify select function
select <- dplyr::select
```

<br>

```{r, include = F}

# recognize sheet title and download
discharge_dat <- read_sheet("https://docs.google.com/spreadsheets/d/1lS9eJ7kX91IlYwSgiEQm-BQqif_7o5E4MzcBmqpwSoI/edit#gid=0", 
                           sheet = "Discharge_Measurements") %>%
  # rename columns
  rename(site = `Site Name`,
         sample_date = `Sample Date`) %>%
  # select needed columns
  select(site,
         sample_date,
         Staff_Plate_Height,
         Q_Discharge_cfs) %>%
  # transform column formats
  transform(Staff_Plate_Height = as.numeric(Staff_Plate_Height),
            Q_Discharge_cfs = as.numeric(Q_Discharge_cfs)) %>%
  # select miller creek pressure transducer site 1
  filter(site == "Miller Creek Pressure Transducer 1")

```

<br>

### Miller Creek Discharge Rating Curve 

A discharge station was established in October 2020 near the mouth of Miller Creek, including a staff plate and pressure transducer.

Site visits will be made opportunistically depending on precipitation throughout Summer/Fall 2021. At each site visit, the pressure transducer is downloaded and a discharge measurement is collected using a SondeTek Flowtracker.

Once a minimum of eight discharge measurements are available in Fall 2021, a curve will be fit to the scatter plot of stage height vs. discharge. This relationship will be used in conjunction with pressure transducer data to create a graph of flow.

```{r}
p <- discharge_dat %>%
  ggplot(aes(Staff_Plate_Height, Q_Discharge_cfs)) +
  geom_point()

fig <- ggplotly(p)

fig

# to do: include date in ggplotly pop-up windows
```

<br>

### Pressure Transducer Data

```{r, include = F}
# directories by date

## to do: tidy up the file read-in process, what a mess

## 20210524
dir <- "input/pressure_transducer_data/20210524/"
  
# parameter 1
`0001_20201014` <- read_csv(paste0(dir,"0001_20201014.csv"))

# parameter 2
`0002_20201014` <- read_csv(paste0(dir,"0002_20201014.csv"))

# join parameters together
`20201014` <- left_join(`0001_20201014`,`0002_20201014`) %>%
  transform(date = dmy(date))


## 20210624
dir <- "input/pressure_transducer_data/20210624/"

# parameter 1
`0001_20210624` <- read_csv(paste0(dir,"0001_20210624.csv"))

# parameter 2
`0002_20210624` <- read_csv(paste0(dir,"0002_20210624.csv"))

# parameter 3
`0003_20210624` <- read_csv(paste0(dir,"0003_20210624.csv"))

# join parameters together
`20210624` <- left_join(`0001_20210624`,`0002_20210624`) %>%
  left_join(`0003_20210624`) %>%
  transform(date = dmy(date))

### join all download dates to single dataframe
pt <- bind_rows(`20201014`,`20210624`) %>%
  # format time to hms
  mutate(foo = as_hms(paste0(time,":00"))) %>%
  select(-time) %>%
  rename(time = foo) %>%
  # create datetime column
  mutate(datetime = ymd_hms(paste(date, time))) %>%
  # make parameter values numeric
  transform(parameter1 = as.numeric(parameter1),
            parameter2 = as.numeric(parameter2),
            parameter3 = as.numeric(parameter3)) %>%
  # make long format
  pivot_longer(cols = contains("parameter"),
               names_to = "param",
               values_to = "val")
  

```

<br>

Plot pressure transducer data (work in progress here 8/6/2021)
```{r}
pt %>%
  ggplot(aes(datetime,val)) +
  geom_point() +
  facet_grid(param ~ .)

# to do : use anti_join method to excise non-instream data from plot
# convert to plotly line chart?
```

