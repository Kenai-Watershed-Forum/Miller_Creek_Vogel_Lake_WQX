# Rotenone monitoring

```{r , include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

# clear environment
rm(list=ls())

# load packages
library(bookdown)
library(tidyverse)
library(googlesheets4)
library(lubridate)
library(readr)
library(readxl)
library(writexl)
library(fs)
library(janitor)
library(hms)
library(plotly)
library(DT)
library(xlsx)
library(leaflet)
library(DT)
library(ggpubr)
library(plotrix)
library(packrat)
library(kableExtra)

# set plotting themes

## geom_col plots theme
col_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 14))

## geom_points plots theme
points_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 11, face = "bold"),
                   title = element_text(size = 18))

# function to exclude multiple items per column
'%ni%' <- Negate('%in%')

# clarify select function
select <- dplyr::select
```

Rotenone application was performed in early October 2021 by ADF&G. ADF&G collected pre and post-treatment water samples as part of this event, and Kenai Watershed Forum will monitor degradation through until Summer 2022. Methods and results will be described here.

## Sampling schedule

A proposed rotenone sampling schedule is described in table \@ref(tab:sample-schedule) or may be accessed in a Google Sheet linked here: <https://tinyurl.com/8ba94nrn>. Schedule is current as of `r Sys.Date()`.

```{r sample-schedule, echo = F, fig.cap = "cap"}
options(knitr.kable.NA = '')

# read in proposed schedule
url <- "https://docs.google.com/spreadsheets/d/1_lv-I471tu8WI55nItGslKYe_X5qvwZ_MF22M2jrkZo/edit#gid=0"
tab <- "rotenone_sample_schedule"
dat <- read_sheet(url, sheet = tab) 

# create table
dat %>%
  kbl(caption = "Vogel lake and Miller Creek rotenone sampling schedule") %>%
  kable_paper(full_width = F, html_font = "Cambria") 

#%>%
 # bootstrap_options = c("striped", "hover", "condensed", "responsive")
```

<br>

## Rotenone concentration results

```{r, data prep, echo = F}

# prepare data for summary and visualization

# read in all rotenone concentration data from csv files (sourced from excel files emailed from UAA)
data_dir <- "input/rotenone_data/rotenone_concentration_results/csv/"

rot_dat <- data_dir %>% 
  dir_ls(regexp = "\\.csv$") %>% 
  map_dfr(read_csv, .id = "source") 

# clean up very messy import

## rename
column_names <- c("source",
                  "sample_name",
                  "field_sample_date",
                  "lab_analysis_date",
                  "rotenone_ppb",
                  "rotenolone_ppb",
                  "deguelin_ppb",
                  "tephrosin_ppb",
                  "cft_5",
                  "cft_6")
colnames(rot_dat) <- column_names 

## designate numeric columns
num_vars <- c("rotenone_ppb", "rotenolone_ppb","deguelin_ppb")

## remove empty columns
rot_dat <- remove_empty(rot_dat)

## remove empty rows and column name rows
rot_dat <- rot_dat %>%
  filter(!is.na(sample_name)) %>%
  filter(field_sample_date != "---") %>%
  filter(sample_name %ni% c("Sample Name*",
                            "*a and b denote separate extraction duplicates",
                            "**ND = Not Detected"))  %>%
  
## separate sample names into columns to better organize them
### distinguish a and b lab duplicates
  separate(sample_name,into = c("sample_name","lab_dup"), sep = "_") %>%
  
### correct for use of "benthic" vs "deep" terminology in sample names
  mutate(sample_name = str_replace(sample_name, pattern = "Vogel Deep", replacement = "Vogel Benthic")) %>%

## assign "ND" (not detected) as zero in numeric columns
  mutate_at(num_vars,funs(str_replace(., "ND", "0"))) %>%
  
## make numbers columns numeric class
  mutate_at(num_vars, as.numeric) %>%
  
## transform other column types
  transform(field_sample_date = mdy(field_sample_date),
            lab_analysis_date = mdy(lab_analysis_date))
  

```

```{r, sample name correction , echo = F}
# sample name correction

# the samples collected 9/27/2021 and 9/28/2021 at Vogel and North Vogel were collected from the surface, but the sample names do not contain the word "Surface." Apply this correction to be consistent with other sample name conventions

rot_dat <- rot_dat %>%
  mutate(sample_name = case_when(
    sample_name == "Vogel" | field_sample_date == "2021-09-27" ~ "Vogel Surface",
    sample_name == "N. Vogel" | field_sample_date == "2021-09-28" ~ "N. Vogel Surface",
    sample_name != "Vogel" | field_sample_date != "2021-09-27" ~ sample_name,
    sample_name != "N. Vogel" | field_sample_date != "2021-09-28" ~ sample_name))  %>%
   
  # add column designation for benthic vs surface vs creek
  mutate(strata = word(sample_name,-1)) %>%
  mutate(strata = ifelse(strata == "Surface" | strata == "Benthic",strata,"Creek")) %>%
  
  # modify sample names to remove spaces
  mutate(sample_name = case_when(
    sample_name == "Vogel Surface" ~ "Vogel_Surface",
    sample_name == "N. Vogel Surface" ~ "N_Vogel_Surface",
    sample_name == "Vogel Benthic" ~ "Vogel_Benthic",
    sample_name == "N. Vogel Benthic" ~ "N_Vogel_Benthic",
    sample_name == "Miller Creek 1" ~ "Miller_Creek_1",
    sample_name == "Miller Creek 2" ~ "Miller_Creek_2",
    sample_name == "Miller Creek Weir" ~ "Miller Creek Weir")) %>%
  
  # add column to designate water body
  mutate(waterbody = case_when(
    sample_name ==  "Vogel_Surface" | sample_name == "Vogel_Benthic" ~ "Vogel_Lake",
    sample_name =="N_Vogel_Surface" | sample_name == "N_Vogel_Benthic" ~ "N_Vogel_Lake")) %>%
  mutate(waterbody = ifelse(!is.na(waterbody), waterbody, "Miller_Creek"))

```

```{r, lab-dups, echo = F, eval = F}

# address lab duplicates. calculate percent difference among lab dups, then finalize into average values for plotting/summary tables

# what is the % difference among lab duplicates?
pct <- rot_dat %>%
  
  # reshape dataframe
  select(sample_name,field_sample_date,lab_dup,rotenone_ppb) %>%
  pivot_wider(names_from = lab_dup, values_from = rotenone_ppb) %>%
    
  # filter na vals
  filter(!is.na(a),
         !is.na(b)) %>%
  select(-"NA") %>%
  
  # calculate percent diff
  mutate(pct_diff = abs((a-b)/(a+b))) %>%
  
  # replace NaN with zeros in pct diff column
  mutate_at(vars(pct_diff),~replace(., is.nan(.), 0)) 
  
# average pct diff
avg_pct_diff <- pct %>% summarise(avg_pct_diff = mean(pct_diff)*100) %>% as.character()

# stdev pct diff
sd_pct_diff <- pct %>% summarise(avg_pct_diff = sd(pct_diff)*100) %>% as.character()

#### insert avg and sd values inline text


```

### Sample results

Laboratory analysis of water samples is performed by the [ASET Laboratory](https://www.uaa.alaska.edu/academics/college-of-arts-and-sciences/departments/chemistry/aset_lab/) at the University of Alaska Anchorage Department of Chemistry in Anchorage, Alaska.

Original results received from UAA are available for download at the following link:

-   [Link: Rotenone Degradation Laboratory Results](https://github.com/Kenai-Watershed-Forum/Miller_Creek_Vogel_Lake_WQX/tree/main/input/rotenone_data).

Final results that have been integrated into a single consistent format are available for download at the the following link:

-   Link: Rotenone Degradation Final Results (add GH link)

A summarised version of the above document is displayed in Table \@ref(tab:rotenone-table)

Table X... ... show abbreviated table w rotenone only; include link to download csv with more complete table

```{r, results table, echo = F}
# save full table to github repo available for download
write.csv(rot_dat,"output/rotenone_results/rotenone_results.csv", row.names = F)
```

```{r, rotenone-table}

# create table
rot_dat %>%
  arrange(waterbody,sample_name,field_sample_date) %>%
  select(sample_name, lab_dup, field_sample_date, waterbody, strata, rotenone_ppb) %>%
  kbl(caption = "Rotenone raw results") %>%
  kable_paper(full_width = F, html_font = "Cambria")

```

```{r, eval = F}

## lakes plot

ggplotly(rot_dat %>%
    # remove miller creek
      filter(waterbody != "Miller_Creek") %>%
    group_by(sample_name,field_sample_date, waterbody,strata) %>%
    summarise(avg_rotenone_ppb = mean(rotenone_ppb)) %>%
  
    ggplot(aes(field_sample_date,avg_rotenone_ppb, color = strata)) +
    geom_point() +
    geom_line() +
    facet_grid(. ~ waterbody) +
      xlab("") +
      ylab("Rotenone Concentration (ppb)")
  )
  

# say that more detailed accuracy results can be accessed in the repo folder in the excel files

# see journal article for methods

```

```{r, eval = F}

## creek plot

## join data with location estimates (distance down creek)


ggplotly(rot_dat %>%
    # include miller creek
      filter(waterbody == "Miller_Creek") %>%
    group_by(sample_name,field_sample_date, waterbody,strata) %>%
    summarise(avg_rotenone_ppb = mean(rotenone_ppb)) %>%
  
    ggplot(aes(field_sample_date,avg_rotenone_ppb, color = strata)) +
    geom_point() +
    geom_line() +
    facet_grid(. ~ waterbody) +
      xlab("") +
      ylab("Rotenone Concentration (ppb)")
  )



```
